
# PostgreSQL
---

{{.AvailableArchs}}

---

Postgresql collector can collect the running status index from Postgresql instance, and collect the index to Guance Cloud to help monitor and analyze various abnormal situations of Postgresql.

## Preconditions {#reqirement}

- Postgresql version >= 9.0
- Create user

```sql
-- PostgreSQL >= 10
create user datakit with password '<PASSWORD>';
grant pg_monitor to datakit;
grant SELECT ON pg_stat_database to datakit;

-- PostgreSQL < 10
create user datakit with password '<PASSWORD>';
grant SELECT ON pg_stat_database to datakit;
```

## Configuration {#config}

Go to the `conf.d/{{.Catalog}}` directory under the DataKit installation directory, copy `{{.InputName}}.conf.sample` and name it `{{.InputName}}.conf`. Examples are as follows:

```toml
{{.InputSample}}
```

After setting it, restart the DataKit.

## Measurements {#measurements}

For all of the following data collections, a global tag named `host` is appended by default (the tag value is the host name of the DataKit), or it can be named by `[[inputs.postgresql.tags]]` alternative host in the configuration.

{{ range $i, $m := .Measurements }}

### `{{$m.Name}}`

- tag

{{$m.TagsMarkdownTable}}

- metric list

{{$m.FieldsMarkdownTable}}

{{ end }}

## Log Collection {#logging}

- Postgresql logs are output to `stderr` by default. To open file logs, configure them in postgresql's configuration file `/etc/postgresql/<VERSION>/main/postgresql.conf` as follows:

```
logging_collector = on    # Enable log writing to files

log_directory = 'pg_log'  # Set the file storage directory, absolute path or relative path (relative PGDATA)

log_filename = 'pg.log'   # Log file name
log_statement = 'all'     # Record all queries

#log_duration = on
log_line_prefix= '%m [%p] %d [%a] %u [%h] %c ' # 日志行前缀
log_file_mode = 0644

# For Windows
#log_destination = 'eventlog'
```

For more configuration, please refer to the [doc](https://www.postgresql.org/docs/11/runtime-config-logging.html){:target="_blank"}。

- The Postgresql collector does not have log collection enabled by default. You can open `files` in `conf.d/db/postgresql.conf`  and write to the absolute path of the Postgresql log file. For example:

```
[[inputs.postgresql]]

  ...

  [inputs.postgresql.log]
  files = ["/tmp/pgsql/postgresql.log"]
```

When log collection is turned on, a log with a log `source` of `postgresql` is generated by default.

**Notices:**

- Log collection only supports logs on hosts where DataKit is installed.

## Log Pipeline Cut {#pipeline}

The original log is

```
2021-05-31 15:23:45.110 CST [74305] test [pgAdmin 4 - DB:postgres] postgres [127.0.0.1] 60b48f01.12241 LOG:  statement:
		SELECT psd.*, 2^31 - age(datfrozenxid) as wraparound, pg_database_size(psd.datname) as pg_database_size
		FROM pg_stat_database psd
		JOIN pg_database pd ON psd.datname = pd.datname
		WHERE psd.datname not ilike 'template%'   AND psd.datname not ilike 'rdsadmin'
		AND psd.datname not ilike 'azure_maintenance'   AND psd.datname not ilike 'postgres'
```

Description of the cut field:

| Field name           | Field Value                  | Description                                                      |
| ---              | ---                     | ---                                                       |
| application_name | pgAdmin 4 - DB:postgres | The name of the application connecting to the current database                                |
| db_name          | test                    | Database accessed                                              |
| process_id       | 74305                   | The client process ID of the current connection                                    |
| remote_host      | 127.0.0.1               | Address of the client                                              |
| session_id       | 60b48f01.12241          | ID of the current session                                              |
| user             | postgres                | Current Access User Name                                            |
| status           | LOG                     | Current log level (LOG,ERROR,FATAL,PANIC,WARNING,NOTICE,INFO) |
| time             | 1622445825110000000     | Log generation time                                              |
