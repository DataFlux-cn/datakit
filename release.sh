#/bin/bash
# date: Wed Jul 21 11:29:22 CST 2021
# author: tan
# NOTE: 必须先发布 Mac 版本，不然 Mac 版本发布会缺少历史安装包入口，参见 #53

branch_name="$(git symbolic-ref HEAD 2>/dev/null)" ||
branch_name="(unnamed branch)"     # detached HEAD

branch_name=${branch_name##refs/heads/}

new_tag=$1
latest_tag=$(git describe --abbrev=0 --tags)

case $branch_name in
	"testing") echo "release test release..."
		make &&
		make pub_testing_mac &&
		git push origin testing
		;;

	"dev") echo "release prod release..."
		if [ -z $new_tag ]; then
			echo "[E] new tag required to release production datakit, latest tag is ${latest_tag}"
		else
			# Release darwin version first
			git tag -f $new_tag  &&
			make release_mac     &&
			make pub_release_mac &&

			echo "[I] darwin prod release ok"

			# Trigger CI to release other platforms
			git push -f --tags   &&
			git push
		fi
		;;

	"github") echo "release to github"
		git push github dev
		;;

	*) echo "[E] unsupported branch '$branch_name' for release, exited"
		;;
esac
