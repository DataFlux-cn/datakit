# ebpf collector

DataKit's ebpf external collector's network-related data collection and offset derivation of kernel structure elements are based on [tcptracer-bpf](https://github.com/weaveworks/tcptracer-bpf) and [datadog-agent network pkg ](https://github.com/DataDog/datadog-agent/tree/main/pkg/network) developed.

Shell command execution record collection supports collecting bash commands executed by the terminal.

Network data collection supports the collection of TCP/UDP network traffic information of the 4th layer transport layer of the OSI model, and the dns request data of the 7th layer application layer. The datasets are netflow and dnsflow.

**datasets:**

- *bash*:
  - tags
    |name|description|
    |-|-|
    |host|System hostname.|
    |source|Fixed value: bash.|
  - fields
    |name|description|type|unit|
    |-|-|-|-|
    |cmd|Command.|string|-|
    |message|The bash execution record generated by the collector.|string|-|
    |pid|Process identification number.|string|-|
    |user|The user who executes the bash command.|string|-|

- *netflow*:
  - tags
    |name|description|
    |-|-|
    |direction|Use the source as a frame of reference to identify the connection initiator. (incoming/outgoing)|
    |src_ip|Source IP.|
    |src_port|Source port.|
    |src_ip_type|Source IP type. (other/private/multicast)|
    |dst_ip|Destination IP address.|
    |dst_port|Destination port.|
    |dst_ip_type|Destination IP type. (other/private/multicast)|
    |dst_nat_ip| For data containing the `outging` tag, this value is the ip after the dnat operation |
    |dst_nat_port| For data containing the `outging` tag, this value is the port after the dnat operation |
    |dst_domain|Destination domain.|
    |src_k8s_pod_name|Source K8s pod name.|
    |src_k8s_deployment_name|Source K8s deployment name.|
    |src_k8s_service_name|Source K8s service name.|
    |src_k8s_namespace|Source K8s namespace.|
    |dst_k8s_pod_name|Destination K8s pod name.|
    |dst_k8s_deployment_name|Destination K8s deployment name.|
    |dst_k8s_service_name|Destination K8s service name.|
    |dst_k8s_namespace|Destination K8s namespace.|
    |pid|Process identification number.|
    |process_name|Process name.|
    |transport|Transport layer protocol. (udp/tcp)|
    |family|Network layer protocol. (IPv4/IPv6)|
    |source|Fixed value: httpflow.|
    |sub_source|Some specific connection classifications, such as the sub_source value for Kubernetes network traffic is K8s.|
    |host|System hostname.|
  - fields
    |name|description|type|unit|
    |-|-|-|-|
    |bytes_read|The number of bytes read.|int|byte|
    |bytes_written|The number of bytes writte.|int|byte|
    |retransmits|The number of retransmissions.|int|-|
    |rtt|TCP Latency.|int|μs|
    |rtt_var|TCP Jitter.|int|μs|
    |tcp_closed|The number of TCP connection closed.|int|-|
    |tcp_established|The number of TCP connection established.|int|-|

- *httpflow*:
  - tags
    |name|description|
    |-|-|
    |direction|Use the source as a frame of reference to identify the connection initiator. (incoming/outgoing)|
    |src_ip|Source IP.|
    |src_port|Source port.|
    |src_ip_type|Source IP type. (other/private/multicast)|
    |dst_ip|Destination IP address.|
    |dst_port|Destination port.|
    |dst_ip_type|Destination IP type. (other/private/multicast)|
    |dst_nat_ip| For data containing the `outging` tag, this value is the ip after the dnat operation |
    |dst_nat_port| For data containing the `outging` tag, this value is the port after the dnat operation |
    |dst_domain|Destination domain.|
    |src_k8s_pod_name|Source K8s pod name.|
    |src_k8s_deployment_name|Source K8s deployment name.|
    |src_k8s_service_name|Source K8s service name.|
    |src_k8s_namespace|Source K8s namespace.|
    |dst_k8s_pod_name|Destination K8s pod name.|
    |dst_k8s_deployment_name|Destination K8s deployment name.|
    |dst_k8s_service_name|Destination K8s service name.|
    |dst_k8s_namespace|Destination K8s namespace.|
    |pid|Process identification number.|
    |process_name|Process name.|
    |transport|Transport layer protocol. (udp/tcp)|
    |family|Network layer protocol. (IPv4/IPv6)|
    |source|Fixed value: httpflow.|
    |sub_source|Some specific connection classifications, such as the sub_source value for Kubernetes network traffic is K8s.|
    |host|System hostname.|
  - fields
    |name|description|type|unit|
    |-|-|-|-|
    |truncated|The length of the request path has reached the upper limit of the number of bytes collected, and the request path may be truncated.|bool|-|
    |path|Request path.|string|-|
    |status_code|Http status codes.|int|-|
    |method|GET/POST/...|string|-|
    |latency|TTFB.|int|ns|
    |http_version|1.1 / 1.0 ...|string|-|
    |count|The total number of HTTP requests in a collection cycle.|int|-|

- *dnsflow*:
  - tags
    |name|description|
    |-|-|
    |direction|Use the source as a frame of reference to identify the connection initiator. (incoming/outgoing)|
    |src_ip|Source IP.|
    |src_port|Source port.|
    |src_ip_type|Source IP type. (other/private/multicast)|
    |dst_ip|Destination IP address.|
    |dst_port|Destination port.|
    |dst_ip_type|Destination IP type. (other/private/multicast)|
    |dst_domain|Destination domain.|
    |src_k8s_pod_name|Source K8s pod name.|
    |src_k8s_deployment_name|Source K8s deployment name.|
    |src_k8s_service_name|Source K8s service name.|
    |src_k8s_namespace|Source K8s namespace.|
    |dst_k8s_pod_name|Destination K8s pod name.|
    |dst_k8s_deployment_name|Destination K8s deployment name.|
    |dst_k8s_service_name|Destination K8s service name.|
    |dst_k8s_namespace|Destination K8s namespace.|
    |transport|Transport layer protocol. (udp/tcp)|
    |family|Network layer protocol. (IPv4/IPv6)|
    |source|Fixed value: httpflow.|
    |sub_source|Some specific connection classifications, such as the sub_source value for Kubernetes network traffic is K8s.|
    |host|System hostname.|
  - fields
    |name|description|type|unit|
    |-|-|-|-|
    |rcode|DNS response code: 0 - NoError, 1 - FormErr, 2 - ServFail, 3 - NXDomain, 4 - NotImp, 5 - Refused, ...|int|-|
    |latency|Average response time for DNS requests.|int|ns|
    |latency_max|Maximum response time for DNS requests.|int|ns|
    |count|The number of DNS requests in a collection cycle.|int|-|
