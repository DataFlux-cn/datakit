//go:build linux
// +build linux

package protodec

import (
	"testing"
)

func TestReadPgsqlBlock(t *testing.T) {
	t.Run("P Request", func(t *testing.T) {
		data := "\x50\x00\x00\x00\x45\x00\x2f\x2a\x74\x65\x73\x74\x2a\x2f\x20\x49" +
			"\x4e\x53\x45\x52\x54\x20\x49\x4e\x54\x4f\x20\x63\x69\x74\x69\x65\x73\x28" +
			"\x6e\x61\x6d\x65\x2c\x20\x70\x6f\x70\x75\x6c\x61\x74\x69\x6f\x6e\x29\x20" +
			"\x56\x41\x4c\x55\x45\x53\x28\x24\x31\x2c\x20\x24\x32\x29\x3b\x00\x00\x00" +
			"\x44\x00\x00\x00\x06\x53\x00\x53\x00\x00\x00\x04"

		tag, length, err := readPgsqlBlock([]byte(data))
		if err != nil {
			t.Fail()
		}
		if tag != 'P' {
			t.Fail()
		}
		t.Logf("tag: %c length: %d", tag, length)

		info := &pgsqlInfo{}

		info.parse([]byte(data))
	})

	t.Run("Q Request", func(t *testing.T) {
		data := "\x51\x00\x00\x00\x24\x2f\x2a\x74\x65\x73\x74\x31\x2a\x2f\x20\x53" +
			"\x45\x4c\x45\x43\x54\x20\x2a\x20\x66\x72\x6f\x6d\x20\x63\x69\x74\x69\x65" +
			"\x73\x3b\x00"
		info := &pgsqlInfo{}

		info.parse([]byte(data))
	})

	t.Run("Insert Response", func(t *testing.T) {
		data := "\x32\x00\x00\x00\x04\x43\x00\x00\x00\x0f\x49\x4e\x53\x45\x52\x54" +
			"\x20\x30\x20\x31\x00\x5a\x00\x00\x00\x05\x49"

		info := &pgsqlInfo{}

		info.parse([]byte(data))
	})

	t.Run("Error Response", func(t *testing.T) {
		data := "\x45\x00\x00\x00\x6a\x53\x45\x52\x52\x4f\x52\x00\x56\x45\x52\x52\x4f" +
			"\x52\x00\x43\x34\x32\x50\x30\x31\x00\x4d\x72\x65\x6c\x61\x74\x69\x6f\x6e\x20" +
			"\x22\x63\x69\x74\x69\x65\x73\x31\x22\x20\x64\x6f\x65\x73\x20\x6e\x6f\x74\x20" +
			"\x65\x78\x69\x73\x74\x00\x50\x32\x35\x00\x46\x70\x61\x72\x73\x65\x5f\x72\x65" +
			"\x6c\x61\x74\x69\x6f\x6e\x2e\x63\x00\x4c\x31\x34\x34\x39\x00\x52\x70\x61\x72" +
			"\x73\x65\x72\x4f\x70\x65\x6e\x54\x61\x62\x6c\x65\x00\x00"
		info := &pgsqlInfo{}

		info.parse([]byte(data))
	})
}

func TestPgsqlProtoDetect(t *testing.T) {
	t.Run("Parse Request", func(t *testing.T) {
		data := "\x50\x00\x00\x00\x45\x00\x2f\x2a\x74\x65\x73\x74\x2a\x2f\x20\x49" +
			"\x4e\x53\x45\x52\x54\x20\x49\x4e\x54\x4f\x20\x63\x69\x74\x69\x65\x73\x28" +
			"\x6e\x61\x6d\x65\x2c\x20\x70\x6f\x70\x75\x6c\x61\x74\x69\x6f\x6e\x29\x20" +
			"\x56\x41\x4c\x55\x45\x53\x28\x24\x31\x2c\x20\x24\x32\x29\x3b\x00\x00\x00" +
			"\x44\x00\x00\x00\x06\x53\x00\x53\x00\x00\x00\x04"

		proto, _, _ := PgsqlProtoDetect([]byte(data), 0)
		if proto != ProtoPgsql {
			t.Fail()
		}
	})

	t.Run("Simple Request", func(t *testing.T) {
		data := "\x51\x00\x00\x00\x24\x2f\x2a\x74\x65\x73\x74\x31\x2a\x2f\x20\x53" +
			"\x45\x4c\x45\x43\x54\x20\x2a\x20\x66\x72\x6f\x6d\x20\x63\x69\x74\x69\x65" +
			"\x73\x3b\x00"

		proto, _, _ := PgsqlProtoDetect([]byte(data), 0)
		if proto != ProtoPgsql {
			t.Fail()
		}
	})
}
